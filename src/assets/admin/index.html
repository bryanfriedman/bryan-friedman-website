<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>
  </head>
  <body>
    <!-- Include the script that builds the page and powers Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      // Fonts (must be registered before CSS that uses them)
      CMS.registerPreviewStyle(
        "https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic&display=swap"
      );
      CMS.registerPreviewStyle(
        "https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800&display=swap"
      );

      // Main site CSS
      CMS.registerPreviewStyle("/css/styles.min.css");

      // Preview-only layout helpers
      CMS.registerPreviewStyle(`
        .decap-preview-wrap { padding: 2rem 1rem; }
        .decap-preview-inner { max-width: 42rem; margin: 0 auto; }
      `, { raw: true });

      const slugify = (s) =>
        String(s || "")
          .trim()
          .toLowerCase()
          .replace(/['"]/g, "")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "");

      const BlogPreview = ({ entry, widgetFor }) => {
        const title = entry.getIn(["data", "title"]) || "";
        const dateRaw = entry.getIn(["data", "date"]) || "";
        const tagsRaw = entry.getIn(["data", "tags"]);

        const tags = Array.isArray(tagsRaw)
          ? tagsRaw
          : (tagsRaw && typeof tagsRaw.toJS === "function" ? tagsRaw.toJS() : []);

        const dateStr = dateRaw
          ? new Date(dateRaw).toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            })
          : "";

        return h("div", { className: "decap-preview-wrap" },
          h("div", { className: "decap-preview-inner" },
            h("article", {},
              h("h1", {}, title),

              dateStr
                ? h("span", { className: "post-meta" },
                    "Posted on ",
                    h("time", { dateTime: dateRaw }, dateStr)
                  )
                : null,

              ...(tags || []).map((t) => {
                const slug = slugify(t);
                return h("span", { className: "post-meta" },
                  " in ",
                  h("a", { href: `/topics/${slug}/` }, t)
                );
              }),

              widgetFor("body")
            )
          )
        );
      };

      CMS.registerPreviewTemplate("blog", BlogPreview);
    </script>
  </body>
</html>