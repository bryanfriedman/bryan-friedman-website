<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>
  </head>
  <body>
    <!-- Include the script that builds the page and powers Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      function rewritePreviewImgSrc(src, slug) {
        if (!src || !slug) return src;

        // leave these alone
        if (
          src.startsWith("blob:") ||
          src.startsWith("data:") ||
          src.startsWith("http://") ||
          src.startsWith("https://") ||
          src.startsWith("/")
        ) return src;

        // normalize ./images/foo.jpg -> images/foo.jpg
        const cleaned = src.replace(/^\.\//, "");

        // your desired mapping
        return `/blog/${slug}/${cleaned}`;
      }

      // Fonts
      CMS.registerPreviewStyle("https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic&display=swap");
      CMS.registerPreviewStyle("https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800&display=swap");

      // CSS
      CMS.registerPreviewStyle("/css/styles.min.css");

      // Preview-only padding
      CMS.registerPreviewStyle(`
        .decap-preview-wrap { padding: 2rem 1rem; }
        .decap-preview-inner { max-width: 42rem; margin: 0 auto; }
      `, { raw: true });

      const slugify = (s) =>
        String(s || "").trim().toLowerCase()
          .replace(/['"]/g, "")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "");

      const BlogPreview = ({ entry, widgetFor }) => {
        const title = entry.getIn(["data", "title"]) || "";
        const dateRaw = entry.getIn(["data", "date"]) || "";
        const tagsRaw = entry.getIn(["data", "tags"]);
        const slug = entry.get("slug");

        const tags = Array.isArray(tagsRaw)
          ? tagsRaw
          : (tagsRaw && typeof tagsRaw.toJS === "function" ? tagsRaw.toJS() : []);

        const dateStr = dateRaw
          ? new Date(dateRaw).toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric"
            })
          : "";

        return h("div", { className: "decap-preview-wrap" },
          h("div", { className: "decap-preview-inner" },
            h("article", { className: "post-preview" },
              h("h1", {}, title),

              dateStr
                ? h("span", { className: "post-meta" },
                    "Posted on ",
                    h("time", { dateTime: dateRaw }, dateStr)
                  )
                : null,

              tags.length
                ? h("span", { className: "post-meta" },
                    " in ",
                    ...tags.flatMap((t, i) => {
                      const link = h("a", { href: `/topics/${slugify(t)}/` }, t);
                      return i === 0 ? [link] : [", ", link];
                    })
                  )
                : null,

              // ðŸ‘‡ THIS IS THE IMPORTANT PART
              h("div", {
                className: "post-body",
                ref: (rootEl) => {
                  if (!rootEl) return;

                  rootEl.querySelectorAll("img").forEach(img => {
                    const src = img.getAttribute("src");
                    img.setAttribute("src", rewritePreviewImgSrc(src, slug));
                  });
                }
              }, widgetFor("body"))
            )
          )
        );
      };

      CMS.registerPreviewTemplate("blog", BlogPreview);
    </script>
  </body>
</html>